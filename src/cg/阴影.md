## 阴影

A shadow is a dark (real image) area where light from a light source is blocked by an opaque object.

阴影，由于光线直进的特性,遇不透光物体而形成的一个暗区。

在光线追踪算法中，确定一个点是否在阴影中，可以从这个点出发，朝光源前进，如果不能到达光源，说明该点位于阴影中。

### 阴影贴图

使用阴影贴图需要增加一轮渲染：

- 第一轮，从灯光的位置渲染场景。然后，对于每个像素，深度缓冲区包含光与最近的对象之间的距离。然后，将深度缓冲区复制到单独的阴影缓冲区。

- 第二轮，正常渲染场景。对于每个像素，在阴影缓冲区中查找相应的位置。如果当前点到光源的距离大于从阴影缓冲区的值，则该点处于阴影之中。计算当前点到光源的距离，可以先把该点变换到相机空间，此时的 z 值就是距离光源的距离。

当发现像素处于阴影中，我们需要使其更暗。一种简单而有效的方法是仅渲染其环境光，忽略其漫反射和镜面反射分量。

#### 阴影贴图的伪影

有许多波浪线覆盖在场景中的表面。这是阴影贴图的常见的副作用，称为阴影痤疮或错误的自阴影。

阴影痤疮是由深度测试期间的舍入误差引起的。在阴影纹理中查找深度信息时计算的纹理坐标通常与实际坐标不完全匹配。因此，从阴影纹理中查找到的深度值可能并非当前渲染中像素的深度，而是相邻像素的深度。如果相邻像素离光源更近，则当前像素会被错误地显示为阴影。

阴影痤疮也会由纹理贴图和深度计算之间的精度引起。则也可能导致舍入误差，并造成对像素是否在阴影中的误判。

幸运的是，阴影痤疮很容易修复。由于阴影痤疮通常发生在没有阴影的表面上，这里有个简单的技巧，在第 1 轮中将每个像素稍微移向光源，之后再第 2 轮将它们移回原位。通常，这么做足以补偿各类舍入误差。注意，如果偏移过大，会产生称为“Peter Panning”的伪影。

注意，因为在第 1 轮渲染场景的区域与第 2 轮中渲染的场景区域不同。这种差异可能导致在第 2 轮渲染场景中，某些区域尝试使用 [0, 1] 之外的特征坐标访问阴影纹理。如果贴图的模式使用的是 repeat， 则有可能发生重复阴影。